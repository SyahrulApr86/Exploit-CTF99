#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

int choice = 0;

void init() {
    setvbuf(stdout, NULL, _IONBF, 0);
}

void menu() {
    puts("\nMenu:");
    puts("1. Create new symlink");
    puts("2. Check the symlink");
    puts("3. Exit");
    printf("> ");
    scanf("%d", &choice);
}

void createSymlink() {
    char filePath[250];
    printf("File path: ");
    scanf("%200s", filePath);

    char symlinkName[250];
    printf("Symlink name (will be hashed): ");
    scanf("%200s", symlinkName);

    char bufSymlink[300];
    char symlinkHashed[20];
    sprintf(bufSymlink, "echo %s | sha256sum | cut -c -10", symlinkName);
    FILE *fp = popen(bufSymlink, "r");
    fscanf(fp, "%s", symlinkHashed);
    pclose(fp);


    char rmBuf[256];
    sprintf(rmBuf, "rm %s", symlinkHashed);
    system(rmBuf);

    int err = symlink(filePath, symlinkHashed);
    if (err != 0) {
        printf("Some error happened when creating symlink.\n");
        return;
    }
    printf("Success creating symlink %s.\n", symlinkHashed);
}

void checkSymlink() {
    char symlinkName[250];
    printf("Symlink name: ");
    scanf("%200s", symlinkName);

    char symlinkPath[250];
    realpath(symlinkName, symlinkPath);

    char flagPath[250];
    flagPath[249] = 0;
    realpath("../flag.txt", flagPath);

    if (strcmp(symlinkPath, flagPath) == 0) {
        printf("Cannot read the flag directly.\n");
        return;
    }
    
    printf("Please wait...\n");
    char buf[1000];
    sprintf(buf, "cat %s > /dev/null", symlinkPath);
    system(buf);

    char bufbuf[1000];
    sprintf(bufbuf, "cat %s", symlinkName);
    system(bufbuf);
}

void useFolder() {
    char folder[250];
    char buf[255];
    char useCustomFolder[5];
    printf("Want to use custom folder? (y/n): ");
    scanf("%3s", useCustomFolder);
    if (strcmp(useCustomFolder, "y") == 0) {
        printf("Folder path: ");
        scanf("%200s", folder);
        sprintf(buf, "./%s", folder);
        int err = chdir(buf);
        if (err == 0) {
            printf("Current directory: ");
            system("pwd");
            return;
        }
        printf("Folder not found. Use default.");
    }

    FILE *fp = popen("RANDOM=$$; echo $RANDOM | sha256sum", "r");
    fscanf(fp, "%s", folder);
    pclose(fp);
    sprintf(buf, "./%s", folder);

    char bufbuf[260];
    sprintf(bufbuf, "mkdir %s", folder);

    system(bufbuf);
    chdir(buf);
    printf("Current directory: ");
    system("pwd");
}

int main() {
    init();

    useFolder();

    while (1) {
        menu();
        if (choice == 1) {
            createSymlink();
        } else if (choice == 2) {
            checkSymlink();
        } else {
            puts("Bye.");
            exit(0);
        }
    }
}